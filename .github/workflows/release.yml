name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  ci:
    name: CI Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-features -- -D warnings

      - name: Check
        run: cargo check --all-features

      - name: Test
        run: cargo test --all-features

  build:
    name: Build ${{ matrix.target }}
    needs: ci
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          # Linux glibc
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          # Linux musl (static)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create archive (Unix)
        if: matrix.archive == 'tar.gz'
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/acp dist/
          cd dist
          tar -czvf ../acp-${{ matrix.target }}.tar.gz acp
          cd ..
          shasum -a 256 acp-${{ matrix.target }}.tar.gz > acp-${{ matrix.target }}.tar.gz.sha256

      - name: Create archive (Windows)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          mkdir dist
          cp target/${{ matrix.target }}/release/acp.exe dist/
          Compress-Archive -Path dist/acp.exe -DestinationPath acp-${{ matrix.target }}.zip
          $hash = (Get-FileHash acp-${{ matrix.target }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  acp-${{ matrix.target }}.zip" | Out-File -Encoding ASCII acp-${{ matrix.target }}.zip.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: acp-${{ matrix.target }}
          path: |
            acp-${{ matrix.target }}.*
          if-no-files-found: error

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}

  publish-crates:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build to generate schemas
        run: cargo build --release

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          cargo publish --no-verify --allow-dirty 2>&1 | tee publish_output.txt || {
            if grep -q "already exists" publish_output.txt; then
              echo "Version already published to crates.io, skipping"
              exit 0
            else
              exit 1
            fi
          }

  publish-npm:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for npm provenance/OIDC
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'  # npm 11.5.1+ required for trusted publishing
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Prepare npm packages
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Platform mapping
          declare -A PLATFORMS=(
            ["aarch64-apple-darwin"]="darwin-arm64"
            ["x86_64-apple-darwin"]="darwin-x64"
            ["x86_64-unknown-linux-gnu"]="linux-x64-gnu"
            ["x86_64-unknown-linux-musl"]="linux-x64-musl"
            ["aarch64-unknown-linux-gnu"]="linux-arm64-gnu"
            ["aarch64-unknown-linux-musl"]="linux-arm64-musl"
            ["x86_64-pc-windows-msvc"]="win32-x64"
          )

          # Create platform packages
          for target in "${!PLATFORMS[@]}"; do
            npm_platform="${PLATFORMS[$target]}"
            pkg_dir="npm-packages/@acp-protocol/cli-${npm_platform}"
            mkdir -p "$pkg_dir/bin"

            # Extract binary
            if [[ "$target" == *"windows"* ]]; then
              unzip -o "artifacts/acp-${target}/acp-${target}.zip" -d "$pkg_dir/bin/"
              binary_name="acp.exe"
            else
              tar -xzf "artifacts/acp-${target}/acp-${target}.tar.gz" -C "$pkg_dir/bin/"
              binary_name="acp"
              chmod +x "$pkg_dir/bin/$binary_name"
            fi

            # Create package.json
            cat > "$pkg_dir/package.json" << EOF
          {
            "name": "@acp-protocol/cli-${npm_platform}",
            "version": "${VERSION}",
            "description": "ACP CLI binary for ${npm_platform}",
            "os": ["$(echo $npm_platform | cut -d'-' -f1 | sed 's/win32/win32/')"],
            "cpu": ["$(echo $npm_platform | cut -d'-' -f2 | sed 's/x64/x64/;s/arm64/arm64/')"],
            "main": "bin/${binary_name}",
            "repository": {
              "type": "git",
              "url": "git+https://github.com/acp-protocol/acp-cli.git"
            },
            "license": "MIT"
          }
          EOF
          done

          # Create main package
          main_dir="npm-packages/@acp-protocol/cli"
          mkdir -p "$main_dir/bin"

          cat > "$main_dir/package.json" << 'PKGJSON'
          {
            "name": "@acp-protocol/cli",
            "version": "VERSION_PLACEHOLDER",
            "description": "AI Context Protocol CLI - Token-efficient code documentation for AI systems",
            "bin": {
              "acp": "bin/acp.js"
            },
            "repository": {
              "type": "git",
              "url": "git+https://github.com/acp-protocol/acp-cli.git"
            },
            "keywords": ["ai", "documentation", "code-analysis", "context", "llm", "cli"],
            "license": "MIT",
            "optionalDependencies": {
              "@acp-protocol/cli-darwin-arm64": "VERSION_PLACEHOLDER",
              "@acp-protocol/cli-darwin-x64": "VERSION_PLACEHOLDER",
              "@acp-protocol/cli-linux-x64-gnu": "VERSION_PLACEHOLDER",
              "@acp-protocol/cli-linux-x64-musl": "VERSION_PLACEHOLDER",
              "@acp-protocol/cli-linux-arm64-gnu": "VERSION_PLACEHOLDER",
              "@acp-protocol/cli-linux-arm64-musl": "VERSION_PLACEHOLDER",
              "@acp-protocol/cli-win32-x64": "VERSION_PLACEHOLDER"
            }
          }
          PKGJSON

          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" "$main_dir/package.json"

          # Create bin wrapper
          cat > "$main_dir/bin/acp.js" << 'WRAPPER'
          #!/usr/bin/env node
          const { execFileSync } = require('child_process');
          const path = require('path');
          const fs = require('fs');

          const PLATFORMS = {
            'darwin-arm64': '@acp-protocol/cli-darwin-arm64',
            'darwin-x64': '@acp-protocol/cli-darwin-x64',
            'linux-x64': '@acp-protocol/cli-linux-x64-gnu',
            'linux-arm64': '@acp-protocol/cli-linux-arm64-gnu',
            'win32-x64': '@acp-protocol/cli-win32-x64',
          };

          // Try musl variants for Linux if glibc not available
          const MUSL_FALLBACKS = {
            'linux-x64': '@acp-protocol/cli-linux-x64-musl',
            'linux-arm64': '@acp-protocol/cli-linux-arm64-musl',
          };

          const platformKey = `${process.platform}-${process.arch}`;
          let pkg = PLATFORMS[platformKey];

          if (!pkg) {
            console.error(`Unsupported platform: ${platformKey}`);
            process.exit(1);
          }

          function tryResolve(packageName) {
            try {
              const pkgPath = require.resolve(`${packageName}/package.json`);
              const pkgDir = path.dirname(pkgPath);
              const pkgJson = require(pkgPath);
              const binName = process.platform === 'win32' ? 'acp.exe' : 'acp';
              return path.join(pkgDir, 'bin', binName);
            } catch {
              return null;
            }
          }

          let binaryPath = tryResolve(pkg);

          // Try musl fallback for Linux
          if (!binaryPath && MUSL_FALLBACKS[platformKey]) {
            binaryPath = tryResolve(MUSL_FALLBACKS[platformKey]);
          }

          if (!binaryPath) {
            console.error(`Could not find ACP binary for ${platformKey}`);
            console.error('Try reinstalling: npm install -g @acp-protocol/cli');
            process.exit(1);
          }

          try {
            execFileSync(binaryPath, process.argv.slice(2), { stdio: 'inherit' });
          } catch (error) {
            if (error.status !== undefined) {
              process.exit(error.status);
            }
            throw error;
          }
          WRAPPER

          chmod +x "$main_dir/bin/acp.js"

      - name: Publish platform packages to npm
        run: |
          for pkg_dir in npm-packages/@acp-protocol/cli-*; do
            if [ -d "$pkg_dir" ]; then
              echo "Publishing $(basename $pkg_dir)..."
              cd "$pkg_dir"
              npm publish --access public --provenance || echo "Failed to publish $(basename $pkg_dir), may already exist"
              cd -
            fi
          done

      - name: Publish main package to npm
        run: |
          cd npm-packages/@acp-protocol/cli
          npm publish --access public --provenance

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download artifacts for SHA256
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Homebrew formula
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Get SHA256 values
          SHA_DARWIN_ARM64=$(cat artifacts/acp-aarch64-apple-darwin/acp-aarch64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          SHA_DARWIN_X64=$(cat artifacts/acp-x86_64-apple-darwin/acp-x86_64-apple-darwin.tar.gz.sha256 | awk '{print $1}')
          SHA_LINUX_ARM64=$(cat artifacts/acp-aarch64-unknown-linux-gnu/acp-aarch64-unknown-linux-gnu.tar.gz.sha256 | awk '{print $1}')
          SHA_LINUX_X64=$(cat artifacts/acp-x86_64-unknown-linux-gnu/acp-x86_64-unknown-linux-gnu.tar.gz.sha256 | awk '{print $1}')

          cat > acp.rb << EOF
          class Acp < Formula
            desc "AI Context Protocol CLI - Token-efficient code documentation for AI systems"
            homepage "https://github.com/acp-protocol/acp-cli"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/acp-protocol/acp-cli/releases/download/v${VERSION}/acp-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_DARWIN_ARM64}"
              end
              on_intel do
                url "https://github.com/acp-protocol/acp-cli/releases/download/v${VERSION}/acp-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_DARWIN_X64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/acp-protocol/acp-cli/releases/download/v${VERSION}/acp-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              end
              on_intel do
                url "https://github.com/acp-protocol/acp-cli/releases/download/v${VERSION}/acp-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              bin.install "acp"
            end

            test do
              assert_match "acp", shell_output("#{bin}/acp --version")
            end
          end
          EOF

          cat acp.rb

      - name: Update Homebrew tap
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: acp-protocol/homebrew-tap
          event-type: update-formula
          client-payload: '{"formula": "acp", "version": "${{ steps.version.outputs.version }}"}'
